
これから，「スマートコントラクトのガス消費量のResource Aware MLを用いた静的解析」という題目で発表させて頂きます．
# 背景

## ブロックチェーンとスマートコントラクト
ブロックチェーンを技術基盤とする仮想通貨で用いられる技術としてスマートコントラクトがあります．
スマートコントラクトは，仮想通貨の取引における契約の締結や履行を自動化する仕組みで，
ブロックチェーン上で動作するプログラムとして実装されます．


## ガス
このスマートコントラクトにはガスの概念が存在します．
ガスはコントラクトの実行のために利用する計算資源にかかる手数料を表している．
コントラクトが実行において，各命令の実行ごとに，その計算コストに応じた量のガスが消費され，消費量の合計が通貨に換算され，手数料として支払われる．
このとき，消費量の合計が上限値を超えると，プログラムの実行が直ちに停止され，プログラムの実行による変更が取り消される．

## 研究の動機
プログラムとして非効率なコントラクトを実行すると，必要以上にガスが消費され無駄な手数料がかかってしまいます．
また，コントラクトを実行しようとする際は，あらかじめ一定量の通貨を支払う必要があるのですが，これは実行が取り消されても返金されません．
このような実行コストの無駄をを抑えるために，ガスの消費量を静的に解析する手法が求められています．

# 本研究の概要
本研究では，仮想通貨Tezosのスマートコントラクトのガス消費量を静的に解析する手法を提案します．
Tezosのスマートコントラクトはスタックベースのプログラミング言語Michelsonで記述されます．
解析には，Resource Aware ML(RAML)という，プログラムのリソース消費量の解析を行うことができる関数型プログラミング言語を用います．
方針としては，まず，MichelsonプログラムをRAMLプログラムに手動でエンコードします．
続いて，エンコードしたプログラムをRAMLで解析することでガス消費量の見積もりを行います．


# Resource Aware ML
手法の説明の前に，RAMLの説明をします．
RAMLは，OCamlで用いられる文法を備えた関数型プログラミング言語で，
入力として与えられたプログラムのリソース消費量の解析を行うツールとして用いることができます．
解析においてメトリックを指定することで，解析するリソースを指定することができます．
本研究では，そのうちの一つであるtickメトリックを用います．
これは，ユーザーの定義したリソース消費量を解析するメトリックで，関数の定義中にtick関数というRAMLに備えられた関数を呼び出すことで，その関数のリソース消費量を定義できます．

## RAMLのプログラム例
これは，クイックソートを行うRAMLプログラムです．
基本的にはOCamlプログラムと同じですが，これはtick関数で，先ほどのtickメトリックを用いる際に関数のリソース消費量を定める関数です．
また，let _ ...から始まる式はmain式で，解析の対象となる式です．
このプログラムでは，append，partition，quicksortの関数定義が行われています．

## 例の解析結果
これは，このプログラムを解析を行った出力の一部です．
解析の際にいくつかのオプションをコマンドラインで指定することができ，stepsはメトリック，1と4は解析の次数の範囲を定めています．
解析の結果として，まずmain式に用いられた関数のそれぞれの解析の結果が示されます．
これはquicksortの型です．
これはquicksortのリソース消費量を表す多項式です．
そして一番下に，main式のリソース消費量の上界が示されます．

# 手法の説明
このRAMLを用いてMichelsonプログラムの解析を行う手法を説明します．

## Michelsonプログラム
Michelsonはスタックベースのプログラミング言語で，
Michelsonのコントラクトは，最初の2行のparameterとstorageと呼ばれる初期スタックに積まれる値の型宣言と，3行目以降の命令列によって構成されています．
そして各命令は受け取ったスタックを書き換えます．
例として，このADD命令とNIL命令に注目すると，命令が適用される前のスタックはこのようにintが2つ積まれています．これにADD命令が適用されると2つのint取り出され，それらの足された値がスタックに積まれます．
そしてNIL命令が適用されると，指定された型の空リストが積まれます．


## RAMLライブラリ
このようなMichelsonプログラムをエンコードするために，Michelsonの各命令の挙動を模倣する関数ライブラリをRAMLで実装します．
このようにスタックの要素をヴァリアント型tとして定義することで，スタックを型tのリストとして扱い，
命令を(t list → t list)型をもつ関数として定義することができます．
例えばADD命令を模倣する関数はこのようになります．
このように設計したライブラリを用いて，Michelsonプログラムを，初期スタックを表すリストに対して関数を連続適用するプログラムとしてエンコードできます．

## ガス消費量の見積もり
次にガス消費量の見積もり方法について説明します．
Tezosのコントラクトの実行におけるガスの消費量は，実行段階によっていくつかのコストに分けられているが，本研究では特にプログラムの解釈実行を行う際に発生するinterpreter costを見積もることを目的とする．
各命令のガス消費量はRAMLのtickメトリックを用いて表現する．
本ライブラリの各命令について，その命令のinterpreter costに相当する値の関数を呼び出すよう定義し，
tickメトリックを用いてエンコードしたプログラムの解析を行い，コントラクトのinterpreter costを見積もる．

# 解析例

## プログラム例
いくつかのMichelsonプログラムについて，それぞれを模倣するRAMLプログラムを作成し，それに対して解析を行いガス消費量の見積もりを行った．
それぞれのプログラムの説明はご覧の通りです．


## 各プログラムの解析結果
それぞれの解析結果はご覧の通りです．interpreter costはそのプログラムの実際のinterepreter costで，derived upper boundはRAMLの解析の結果として得られた上界です．
example1とexample2では解析結果として実際のコストより小さい値が得られましたが，
これは整数値の演算命令のinterpreter costがスタック中の値に依存しているという点を正しく見積もることができなかったと考えられます．
example4のようなリストに対する再帰を行う命令を含むプログラムついては解析自体が行えませんでした．
以上のような正しく見積もりが行えない命令を見直すことは，今後の課題といえます．


# まとめ
本研究のまとめです．
本研究ではMichelsonの各命令を模倣するライブラリをRAMLで作成し，そのライブラリを用いてMichelsonプログラムをRAMLでエンコードしました．
エンコードしたRAMLプログラムをtickメトリックを用いて解析することで，コントラクトのガス消費量の1つであるinterpreter costを見積もりました．
今後の課題として，実装したライブラリの拡張などが挙げられます．